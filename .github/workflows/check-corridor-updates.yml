# GitHub Action to automatically check for corridor geometry updates
# Runs monthly and creates an issue if updates are needed

name: Check Interstate Corridor Updates

on:
  # Run on the 1st of every month at 2 AM UTC
  schedule:
    - cron: '0 2 1 * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install pg axios

      - name: Check for corridor updates
        id: check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          node scripts/check_corridor_updates.js > check_output.txt 2>&1
          EXIT_CODE=$?
          cat check_output.txt

          # Parse output for counts
          NEEDS_UPDATE=$(grep -oP "Needs update.*?\K\d+" check_output.txt || echo "0")
          SIGNIFICANT=$(grep -oP "Significant update needed.*?\K\d+" check_output.txt || echo "0")

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "significant=$SIGNIFICANT" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          cat check_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create database backup before auto-update
        id: backup
        if: |
          steps.check.outputs.exit_code == '1' &&
          steps.check.outputs.significant == '0' &&
          steps.check.outputs.needs_update != '0' &&
          steps.check.outputs.needs_update < '6'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üì¶ Creating backup before auto-update..."

          # Create backup SQL
          cat > backup_corridors.sql << 'EOFBACKUP'
          -- Backup corridors table before auto-update
          CREATE TABLE IF NOT EXISTS corridors_backup_$(date +%Y%m%d) AS
          SELECT * FROM corridors WHERE name LIKE 'I-%';
          EOFBACKUP

          # Execute backup (using psql if available, or note for manual backup)
          if command -v psql &> /dev/null; then
            psql "$DATABASE_URL" < backup_corridors.sql
            echo "backup_created=true" >> $GITHUB_OUTPUT
          else
            echo "backup_created=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  psql not available - backup SQL saved to artifact"
          fi

      - name: Auto-update corridors (safe mode)
        id: autoupdate
        if: |
          steps.check.outputs.exit_code == '1' &&
          steps.check.outputs.significant == '0' &&
          steps.check.outputs.needs_update != '0' &&
          steps.check.outputs.needs_update < '6'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ü§ñ AUTO-UPDATE MODE: Safe to update (minor changes only)"
          echo "   Corridors needing update: ${{ steps.check.outputs.needs_update }}"
          echo "   Significant updates: ${{ steps.check.outputs.significant }}"
          echo ""

          # Run the update
          node scripts/fetch_all_interstate_geometries.js > update_output.txt 2>&1
          UPDATE_EXIT=$?

          cat update_output.txt

          if [ $UPDATE_EXIT -eq 0 ]; then
            echo "‚úÖ Auto-update completed successfully"
            echo "update_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Auto-update failed"
            echo "update_success=false" >> $GITHUB_OUTPUT
          fi

          echo "update_output<<EOF" >> $GITHUB_OUTPUT
          cat update_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create success notification issue
        if: |
          steps.autoupdate.outputs.update_success == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const needsUpdate = '${{ steps.check.outputs.needs_update }}';
            const updateOutput = `${{ steps.autoupdate.outputs.update_output }}`;
            const backupCreated = '${{ steps.backup.outputs.backup_created }}';

            const title = `‚úÖ Interstate Corridors Auto-Updated Successfully`;

            const body = `## ‚úÖ Automated Corridor Update - Success

The monthly automated update has successfully refreshed interstate corridor geometries from OpenStreetMap.

### Summary
- **Corridors Updated:** ${needsUpdate}
- **Update Type:** Minor changes (auto-approved)
- **Update Date:** ${new Date().toLocaleString()}
- **Backup Created:** ${backupCreated === 'true' ? 'Yes' : 'Noted in artifacts'}

### What Was Updated
The following corridors had minor geometry improvements from OpenStreetMap:
- New construction projects reflected
- Route accuracy improvements
- Updated interchange data

### Safety Checks Passed
- ‚úÖ No significant updates (>180 days) detected
- ‚úÖ Less than 6 corridors needed updating
- ‚úÖ All updates were recent/minor changes
- ‚úÖ Database backup created before update

### Verification
You can verify the updates in the application:
1. Navigate to the map view
2. Check TETC Corridors layer
3. Corridors should display with updated geometry

### Rollback (if needed)
If you notice any issues, you can rollback:

\`\`\`sql
-- List available backups
SELECT tablename FROM pg_tables
WHERE tablename LIKE 'corridors_backup_%'
ORDER BY tablename DESC;

-- Rollback to backup (replace date)
BEGIN;
DELETE FROM corridors WHERE name LIKE 'I-%';
INSERT INTO corridors
SELECT * FROM corridors_backup_YYYYMMDD;
COMMIT;
\`\`\`

### Full Update Log

<details>
<summary>Click to expand update output</summary>

\`\`\`
${updateOutput}
\`\`\`

</details>

---
*This update was performed automatically by the corridor monitoring system. Updates are only automated for minor changes (<180 days old, <6 corridors). Significant changes require manual approval.*
`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated', 'data-quality', 'success']
            });

      - name: Create issue for SIGNIFICANT updates (manual approval required)
        if: |
          steps.check.outputs.exit_code == '1' &&
          (steps.check.outputs.significant != '0' || steps.check.outputs.needs_update >= '6')
        uses: actions/github-script@v6
        with:
          script: |
            const output = `${{ steps.check.outputs.output }}`;

            // Parse output to extract summary
            const needsUpdateMatch = output.match(/Needs update.*?(\d+) corridors/);
            const significantMatch = output.match(/Significant update needed.*?(\d+) corridors/);

            const needsUpdate = needsUpdateMatch ? parseInt(needsUpdateMatch[1]) : 0;
            const significant = significantMatch ? parseInt(significantMatch[1]) : 0;

            const title = significant > 0
              ? `üî¥ Interstate Corridor Geometries Need MANUAL Update (Significant Changes)`
              : `‚ö†Ô∏è Interstate Corridor Geometries Need MANUAL Update (Too Many Changes)`;

            const body = `## ‚ö†Ô∏è Corridor Geometry Update Requires MANUAL Approval

The automated monthly check has detected **significant changes** or **too many corridors** needing updates.

**Automatic update was SKIPPED** - manual review and approval required for safety.

### Why Manual Approval?
${significant > 0 ? `
- üî¥ **Significant updates detected** (${significant} corridors >180 days old)
- Major route changes may require verification
- Could indicate construction projects or realignments
` : ''}
${needsUpdate >= 6 ? `
- ‚ö†Ô∏è **Many corridors need updating** (${needsUpdate} corridors)
- Bulk update should be reviewed
- May indicate widespread OSM improvements
` : ''}

### Summary
- **Needs Update (30-180 days old):** ${needsUpdate} corridors
- **Significant Update (>180 days old):** ${significant} corridors

### What This Means
OpenStreetMap data for these interstates has been updated with:
- Construction/realignment projects
- Improved route accuracy
- New interchange data
- Route corrections

### Manual Update Required

**Review the changes**, then run the update script on Railway:

\`\`\`bash
railway run node scripts/fetch_all_interstate_geometries.js
\`\`\`

This will:
- Fetch latest OSM data for all interstates
- Update corridor geometries with improved accuracy
- Maintain split highway separation (EB/WB, NB/SB)
- Take ~10 minutes to complete

### Safety Notes
- Automatic updates only occur for minor changes (<6 corridors, <180 days)
- This requires manual approval to ensure data quality
- A backup will be created automatically during manual update

### Full Check Output

<details>
<summary>Click to expand detailed results</summary>

\`\`\`
${output}
\`\`\`

</details>

### More Information
See \`docs/CORRIDOR_GEOMETRY_FIX.md\` for complete documentation.

---
*This issue was automatically created by the corridor update checker. It runs monthly on the 1st of each month.*
`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'data-quality', 'automated']
            });

      - name: Update check successful
        if: steps.check.outputs.exit_code == '0'
        run: |
          echo "‚úÖ All corridor geometries are up to date!"
          echo "No action needed at this time."
